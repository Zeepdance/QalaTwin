<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D —Ä–µ–¥–∞–∫—Ç–æ—Ä ‚Äî Building Inspector + Civil Engineering</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }

    /* LEFT PANEL */
    #info{
      position:absolute;
      top:20px; left:20px;
      background: rgba(20,20,20,0.95);
      backdrop-filter: blur(5px);
      color:#fff;
      padding:20px;
      border-radius:12px;
      border:1px solid #444;
      width:300px;
      z-index:100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.8);
      pointer-events: all;

      max-height: calc(100vh - 40px);
      overflow-y: auto;
      scrollbar-width: thin;
      transition: all 0.3s ease;
    }

    #info.collapsed {
      width: 70px;
      padding: 20px 10px;
    }

    #info.collapsed h2,
    #info.collapsed .btn:not(.collapse-btn),
    #info.collapsed .slider-container,
    #info.collapsed .coord-control,
    #info.collapsed .export-import,
    #info.collapsed #selected-info,
    #info.collapsed h3,
    #info.collapsed .hint,
    #info.collapsed .status,
    #info.collapsed .value-badge {
      display: none;
    }

    #info.collapsed .btn {
      display: none;
    }

    #info.collapsed #addCubeBtn,
    #info.collapsed #deleteBtn,
    #info.collapsed #sendToMapBtn {
      display: block;
      width: 50px;
      height: 50px;
      padding: 0;
      border-radius: 10px;
      font-size: 24px;
      line-height: 50px;
      text-align: center;
      margin: 5px auto;
    }

    #info.collapsed #addCubeBtn span,
    #info.collapsed #deleteBtn span,
    #info.collapsed #sendToMapBtn span {
      display: none;
    }

    #info.collapsed #addCubeBtn::before {
      content: "+";
    }

    #info.collapsed #deleteBtn::before {
      content: "üóë";
    }

    #info.collapsed #sendToMapBtn::before {
      content: "üì§";
    }

    /* RIGHT PANEL */
    #inspector{
      position:absolute;
      top:20px; right:20px;
      background: rgba(20,20,20,0.95);
      backdrop-filter: blur(6px);
      color:#fff;
      padding:18px;
      border-radius:12px;
      border:1px solid #444;
      width:360px;
      z-index:100;
      box-shadow: 0 6px 26px rgba(0,0,0,0.8);
      pointer-events: all;

      max-height: calc(100vh - 40px);
      overflow-y: auto;
      scrollbar-width: thin;
      transition: all 0.3s ease;
    }

    #inspector.collapsed {
      width: 70px;
      padding: 18px 10px;
    }

    #inspector.collapsed h2,
    #inspector.collapsed .ins-section,
    #inspector.collapsed .field,
    #inspector.collapsed button:not(.collapse-btn),
    #inspector.collapsed .kv,
    #inspector.collapsed .chip,
    #inspector.collapsed .warn,
    #inspector.collapsed .ok,
    #inspector.collapsed .hint {
      display: none;
    }

    /* –ö–Ω–æ–ø–∫–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
    .collapse-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: #333;
      border: 1px solid #666;
      border-radius: 50%;
      color: #fff;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 200;
    }

    .collapse-btn:hover {
      background: #555;
      border-color: #888;
    }

    #inspector .collapse-btn {
      right: 10px;
      left: auto;
    }

    #info .collapse-btn {
      right: 10px;
      left: auto;
    }

    #info.collapsed .collapse-btn {
      display: flex;
    }

    #inspector.collapsed .collapse-btn {
      display: flex;
    }

    #info h2{
      margin:0 0 15px 0;
      color:#fff;
      font-size:1.4rem;
      border-bottom: 1px solid #444;
      padding-bottom: 8px;
      font-weight: 300;
      letter-spacing: 1px;
    }

    #inspector h2{
      margin:0 0 12px 0;
      color:#fff;
      font-size:1.15rem;
      border-bottom: 1px solid #444;
      padding-bottom: 8px;
      font-weight: 300;
      letter-spacing: 1px;
    }

    /* nice scrollbars */
    #info::-webkit-scrollbar,
    #inspector::-webkit-scrollbar { width: 10px; }
    #info::-webkit-scrollbar-thumb,
    #inspector::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0.5);
    }
    #info::-webkit-scrollbar-track,
    #inspector::-webkit-scrollbar-track{
      background: rgba(0,0,0,0.3);
      border-radius: 999px;
    }

    .btn{
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding:10px 15px;
      font-size:1rem;
      font-weight:300;
      border-radius:6px;
      cursor:pointer;
      margin:5px 0;
      transition: 0.2s;
      width:100%;
      letter-spacing: 0.5px;
    }
    .btn:hover{ background: #444; border-color: #777; }
    .btn.secondary{
      background: #222;
      color:#fff;
      border:1px solid #444;
    }
    .btn.secondary:hover{ background: #2a2a2a; }

    .btn.danger{
      background: #442222;
      color:#fff;
      border:1px solid #663333;
    }
    .btn.danger:hover{
      background: #552222;
    }

    .btn.primary{
      background: #2a4a2a;
      border-color: #3a6a3a;
    }
    .btn.primary:hover{
      background: #3a5a3a;
    }

    .slider-container{ margin-bottom: 15px; }
    .slider-container label{
      display:flex; justify-content:space-between;
      color:#ccc; font-size:0.9rem; margin-bottom:5px;
    }
    .slider-container input{ width:100%; accent-color: #666; }

    .coord-control{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:5px;
      margin:15px 0;
    }
    .coord-btn{
      background:#222;
      border:1px solid #444;
      color:#fff;
      padding:8px;
      border-radius:4px;
      cursor:pointer;
      font-weight:300;
    }
    .coord-btn:hover{ background:#2a2a2a; border-color:#666; }

    #selected-info{
      background:#222;
      padding:12px;
      border-radius:8px;
      text-align:center;
      color:#ccc;
      font-size:0.9rem;
      margin:15px 0;
      border:1px dashed #444;
    }
    .export-import{
      display:flex;
      gap:5px;
      margin-top:10px;
    }
    .export-import button{ flex:1; }

    .value-badge{
      background:#222;
      padding:3px 8px;
      border-radius:20px;
      font-family: monospace;
      color:#fff;
      border: 1px solid #444;
    }
    .status{
      color:#0f0;
      font-size:0.8rem;
      text-align:center;
      margin-top:10px;
      opacity:0.8;
    }

    /* Inspector blocks */
    .ins-section{
      margin-top:12px;
      padding:12px;
      border-radius:10px;
      border: 1px solid #333;
      background: rgba(0,0,0,0.2);
    }
    .ins-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:400;
      font-size:0.95rem;
      margin-bottom:8px;
      color: #fff;
    }
    .chip{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 10px;
      font-size:0.9rem;
      color: #ddd;
    }
    .kv .k{ color: #aaa; }
    .kv .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #fff;
    }

    .field{ display:grid; gap:6px; margin-top:10px; }
    .field label{ color: #aaa; font-size:0.85rem; }
    .field input,.field select,.field textarea{
      width:100%;
      padding:10px 10px;
      border-radius:8px;
      border:1px solid #333;
      background: #1a1a1a;
      color: #fff;
      outline:none;
    }
    .field input:focus,.field select:focus,.field textarea:focus{
      border-color: #666;
    }
    .field textarea{ min-height: 70px; resize: vertical; }

    .warn{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      border:1px solid #663333;
      background: #332222;
      color: #ffaaaa;
      font-size:0.88rem;
      line-height:1.35;
      display:none;
    }
    .ok{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      border:1px solid #336633;
      background: #223322;
      color: #aaffaa;
      font-size:0.88rem;
      line-height:1.35;
      display:none;
    }

    .hint{
      margin-top:10px;
      padding:10px;
      border-radius:10px;
      border:1px solid #333;
      background: #1a1a1a;
      color: #aaa;
      font-size:0.85rem;
      line-height:1.35;
    }
  </style>
</head>
<body>
  <!-- LEFT PANEL -->
  <div id="info">
    <button class="collapse-btn" id="collapseLeftBtn" onclick="toggleLeftPanel()">‚óÄ</button>
    
    <h2>3D –ö–û–ù–°–¢–†–£–ö–¢–û–†</h2>

    <button class="btn" id="addCubeBtn"><span>+ –î–æ–±–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ</span></button>
    <button class="btn danger" id="deleteBtn"><span>üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</span></button>
    <button class="btn primary" id="sendToMapBtn"><span>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É</span></button>

    <div class="hint">
      –í—ã–±–æ—Ä: –∫–ª–∏–∫–Ω–∏ –ø–æ –∑–¥–∞–Ω–∏—é<br>
      –£–¥–∞–ª–µ–Ω–∏–µ: Delete/Backspace
    </div>

    <h3 style="margin: 15px 0 10px; color: #fff; font-weight: 300;">–†–ê–ó–ú–ï–†–´</h3>
    <div class="slider-container">
      <label>–®–∏—Ä–∏–Ω–∞ <span id="widthVal" class="value-badge">1.0 –º</span></label>
      <input type="range" id="widthSlider" min="0.2" max="3.0" step="0.1" value="1.0">
    </div>
    <div class="slider-container">
      <label>–í—ã—Å–æ—Ç–∞ <span id="heightVal" class="value-badge">1.2 –º</span></label>
      <input type="range" id="heightSlider" min="0.2" max="6.0" step="0.1" value="1.2">
    </div>
    <div class="slider-container">
      <label>–ì–ª—É–±–∏–Ω–∞ <span id="depthVal" class="value-badge">1.0 –º</span></label>
      <input type="range" id="depthSlider" min="0.2" max="3.0" step="0.1" value="1.0">
    </div>

    <h3 style="margin: 15px 0 10px; color: #fff; font-weight: 300;">–ü–û–ó–ò–¶–ò–Ø (–ª–æ–∫–∞–ª—å–Ω–æ)</h3>
    <div class="coord-control">
      <button class="coord-btn" id="moveLeft">‚óÄ X-</button>
      <button class="coord-btn" id="moveRight">X+ ‚ñ∂</button>
      <button class="coord-btn" id="moveDown">Y- ‚ñº</button>
      <button class="coord-btn" id="moveUp">Y+ ‚ñ≤</button>
      <button class="coord-btn" id="moveBack">Z- ‚¨á</button>
      <button class="coord-btn" id="moveForward">Z+ ‚¨Ü</button>
    </div>

    <div id="selected-info">üëÜ –ö–ª–∏–∫–Ω–∏ –ø–æ –∑–¥–∞–Ω–∏—é –¥–ª—è –≤—ã–±–æ—Ä–∞</div>

    <div class="export-import">
      <button class="btn secondary" id="exportBtn">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <button class="btn secondary" id="importBtn">üì• –ò–º–ø–æ—Ä—Ç</button>
    </div>
    <button class="btn secondary" id="copyToClipboardBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>

    <div id="statusMsg" class="status"></div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="inspector">
    <button class="collapse-btn" id="collapseRightBtn" onclick="toggleRightPanel()">‚ñ∂</button>
    
    <h2>BUILDING INSPECTOR</h2>

    <div class="ins-section">
      <div class="ins-title">
        <span>–¢–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç</span>
        <span id="bId" class="chip">‚Äî</span>
      </div>

      <div class="kv">
        <div class="k">–ü–æ–∑–∏—Ü–∏—è</div><div class="v" id="bPos">‚Äî</div>
        <div class="k">–†–∞–∑–º–µ—Ä—ã (–º)</div><div class="v" id="bSize">‚Äî</div>
        <div class="k">–ü—è—Ç–Ω–æ –∑–∞—Å—Ç—Ä–æ–π–∫–∏</div><div class="v" id="bFootprint">‚Äî</div>
        <div class="k">–û–±—ä—ë–º</div><div class="v" id="bVolume">‚Äî</div>
        <div class="k">–í—ã—Å–æ—Ç–∞</div><div class="v" id="bHeightM">‚Äî</div>
        <div class="k">–≠—Ç–∞–∂–µ–π</div><div class="v" id="bFloorsAuto">‚Äî</div>
        <div class="k">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</div><div class="v" id="bUseTag">‚Äî</div>
      </div>

      <div id="warnBox" class="warn"></div>
      <div id="okBox" class="ok"></div>
    </div>

    <div class="ins-section">
      <div class="ins-title">
        <span>–î–∞–Ω–Ω—ã–µ –¥–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–æ–≤</span>
        <span class="chip">meta</span>
      </div>

      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è</label>
        <input id="metaName" placeholder="–ù–∞–ø—Ä. –ñ–ö ¬´Altai Tower¬ª" />
      </div>

      <div class="field">
        <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</label>
        <select id="metaUse">
          <option value="residential">–ñ–∏–ª–æ–µ</option>
          <option value="office">–û—Ñ–∏—Å</option>
          <option value="mixed">–°–º–µ—à–∞–Ω–Ω–æ–µ</option>
          <option value="school">–®–∫–æ–ª–∞</option>
          <option value="hospital">–ë–æ–ª—å–Ω–∏—Ü–∞</option>
          <option value="mall">–¢–¶</option>
          <option value="industrial">–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ</option>
          <option value="other">–î—Ä—É–≥–æ–µ</option>
        </select>
      </div>

      <div class="field">
        <label>–ú–∞—Ç–µ—Ä–∏–∞–ª —Ñ–∞—Å–∞–¥–∞</label>
        <input id="metaMaterial" placeholder="–°—Ç–µ–∫–ª–æ/–±–µ—Ç–æ–Ω/–∫–∏—Ä–ø–∏—á..." />
      </div>

      <div class="field">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="metaNotes" placeholder="–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—ã—Å–æ—Ç–µ, –ø–∞—Ä–∫–æ–≤–∫–∞, –¥–≤–æ—Ä..."></textarea>
      </div>

      <button class="btn secondary" id="applyMetaBtn">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="ins-section">
      <div class="ins-title">
        <span>Civil Engineering</span>
        <span class="chip">estimates</span>
      </div>

      <div class="field">
        <label>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</label>
        <select id="ceSystem">
          <option value="rc_frame">–ñ/–± –∫–∞—Ä–∫–∞—Å</option>
          <option value="steel_frame">–°—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä–∫–∞—Å</option>
          <option value="masonry">–ö–∏—Ä–ø–∏—á/–±–ª–æ–∫–∏</option>
          <option value="timber">–î–µ—Ä–µ–≤–æ</option>
          <option value="modular">–ú–æ–¥—É–ª—å–Ω–æ–µ</option>
        </select>
      </div>

      <div class="field">
        <label>–ì—Ä—É–Ω—Ç</label>
        <select id="ceSoil">
          <option value="rock">–°–∫–∞–ª—å–Ω—ã–π</option>
          <option value="dense">–ü–ª–æ—Ç–Ω—ã–π</option>
          <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
          <option value="soft">–°–ª–∞–±—ã–π</option>
        </select>
      </div>

      <div class="field">
        <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
        <select id="ceComplexity">
          <option value="low">–ù–∏–∑–∫–∞—è</option>
          <option value="mid" selected>–°—Ä–µ–¥–Ω—è—è</option>
          <option value="high">–í—ã—Å–æ–∫–∞—è</option>
        </select>
      </div>

      <div class="kv" style="margin-top:10px">
        <div class="k">GFA</div><div class="v" id="ceGfa">‚Äî</div>
        <div class="k">–°—Ç–æ–∏–º–æ—Å—Ç—å</div><div class="v" id="ceCost">‚Äî</div>
        <div class="k">–°—Ä–æ–∫ —Å—Ç—Ä–æ–π–∫–∏</div><div class="v" id="ceTime">‚Äî</div>
        <div class="k">CO‚ÇÇ</div><div class="v" id="ceCo2">‚Äî</div>
        <div class="k">–ú–∞—Å—Å–∞</div><div class="v" id="ceMass">‚Äî</div>
        <div class="k">–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≥—Ä—É–Ω—Ç</div><div class="v" id="ceBearing">‚Äî</div>
        <div class="k">–ü–∞—Ä–∫–æ–≤–∫–∞</div><div class="v" id="ceParking">‚Äî</div>
        <div class="k">–ü–∏–∫–æ–≤—ã–π –ø–æ—Ç–æ–∫ –ª—é–¥–µ–π</div><div class="v" id="cePeopleFlow">‚Äî</div>
      </div>
    </div>

    <div class="ins-section">
      <div class="ins-title">
        <span>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</span>
        <span class="chip">rules</span>
      </div>

      <div class="kv">
        <div class="k">1 unit</div><div class="v">= <span id="ruleScale">10</span> –º</div>
        <div class="k">–ú–∞–∫—Å –≤—ã—Å–æ—Ç–∞</div><div class="v"><span id="ruleMaxH">60</span> –º</div>
        <div class="k">–ú–∞–∫—Å –ø—è—Ç–Ω–æ</div><div class="v"><span id="ruleMaxF">2500</span> –º¬≤</div>
        <div class="k">–†–∞–±–æ—á–∞—è –∑–æ–Ω–∞</div><div class="v"><span id="ruleZone">¬±10</span> –º</div>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ======= –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–í–û–†–ê–ß–ò–í–ê–ù–ò–Ø =======
    window.toggleLeftPanel = function() {
      const panel = document.getElementById('info');
      const btn = document.getElementById('collapseLeftBtn');
      panel.classList.toggle('collapsed');
      if (panel.classList.contains('collapsed')) {
        btn.textContent = '‚ñ∂';
      } else {
        btn.textContent = '‚óÄ';
      }
    };

    window.toggleRightPanel = function() {
      const panel = document.getElementById('inspector');
      const btn = document.getElementById('collapseRightBtn');
      panel.classList.toggle('collapsed');
      if (panel.classList.contains('collapsed')) {
        btn.textContent = '‚óÄ';
      } else {
        btn.textContent = '‚ñ∂';
      }
    };

    // ======= RULES / SCALE =======
    const UNIT_TO_M = 10;        // 1 unit = 10 meters
    const MAX_HEIGHT_M = 60;
    const MAX_FOOTPRINT_M2 = 2500;
    const ZONE_LIMIT_UNITS = 10;

    // —ç—Ç–∞–∂–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –∞–≤—Ç–æ:
    const FLOOR_HEIGHT_M = 3.2;  // —Å—Ä–µ–¥–Ω—è—è –≤—ã—Å–æ—Ç–∞ —ç—Ç–∞–∂–∞
    const ROOF_TECH_M = 1.0;     // —Ç–µ—Ö. —ç—Ç–∞–∂/–∫—Ä–æ–≤–ª—è (–æ—á–µ–Ω—å –≥—Ä—É–±–æ)

    // ======= CIVIL ENGINEERING (VERY rough heuristics) =======
    const COST_PER_M2 = { rc_frame: 850, steel_frame: 950, masonry: 700, timber: 800, modular: 780 };
    const CO2_PER_M2  = { rc_frame: 420, steel_frame: 520, masonry: 300, timber: 180, modular: 260 };
    const DEADLOAD_KN_PER_M2 = { rc_frame: 7.5, steel_frame: 6.0, masonry: 8.5, timber: 4.5, modular: 5.5 };
    const SOIL_BEARING_KPA = { rock: 600, dense: 300, medium: 150, soft: 80 };
    const COMPLEXITY_MULT = { low: 0.9, mid: 1.0, high: 1.25 };

    const USE_FACTORS = {
      residential: { people_per_m2: 0.03,  parking_per_1000m2: 30 },
      office:      { people_per_m2: 0.06,  parking_per_1000m2: 45 },
      mixed:       { people_per_m2: 0.045, parking_per_1000m2: 40 },
      school:      { people_per_m2: 0.08,  parking_per_1000m2: 20 },
      hospital:    { people_per_m2: 0.07,  parking_per_1000m2: 35 },
      mall:        { people_per_m2: 0.09,  parking_per_1000m2: 70 },
      industrial:  { people_per_m2: 0.015, parking_per_1000m2: 15 },
      other:       { people_per_m2: 0.04,  parking_per_1000m2: 30 }
    };

    // ======= Auto visual by use =======
    const USE_VISUAL_PRESET = {
      residential: { shapeType: "box",     facadeStyle: "bands",     color: 0xcccccc },
      office:      { shapeType: "tower",   facadeStyle: "darkglass", color: 0xaaaaaa },
      mixed:       { shapeType: "stepped", facadeStyle: "grid",      color: 0xbbbbbb },
      school:      { shapeType: "lshape",  facadeStyle: "clean",     color: 0xdddddd },
      hospital:    { shapeType: "box",     facadeStyle: "clean",     color: 0xeeeeee },
      mall:        { shapeType: "stepped", facadeStyle: "bands",     color: 0xcccccc },
      industrial:  { shapeType: "box",     facadeStyle: "grid",      color: 0x999999 },
      other:       { shapeType: "box",     facadeStyle: "clean",     color: 0xffffff }
    };

    // --- Scene ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(5, 5, 5);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.screenSpacePanning = true;

    // Lights
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
    dirLight.position.set(3, 8, 4);
    dirLight.castShadow = true;
    dirLight.receiveShadow = true;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;
    const d = 12;
    dirLight.shadow.camera.left = -d;
    dirLight.shadow.camera.right = d;
    dirLight.shadow.camera.top = d;
    dirLight.shadow.camera.bottom = -d;
    dirLight.shadow.camera.near = 2;
    dirLight.shadow.camera.far = 20;
    dirLight.shadow.bias = -0.0005;
    scene.add(dirLight);

    scene.add(new THREE.AmbientLight(0x333333));

    const fillLight = new THREE.PointLight(0x444444, 0.5);
    fillLight.position.set(0, 2, 2);
    scene.add(fillLight);

    // Grid
    const gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0x444444);
    gridHelper.position.y = 0;
    scene.add(gridHelper);

    // State
    const cubes = [];
    const planes = [];
    let selectedCube = null;

    // DOM
    const bId = document.getElementById('bId');
    const bPos = document.getElementById('bPos');
    const bSize = document.getElementById('bSize');
    const bFootprint = document.getElementById('bFootprint');
    const bVolume = document.getElementById('bVolume');
    const bHeightM = document.getElementById('bHeightM');
    const bFloorsAuto = document.getElementById('bFloorsAuto');
    const bUseTag = document.getElementById('bUseTag');
    const warnBox = document.getElementById('warnBox');
    const okBox = document.getElementById('okBox');

    const metaName = document.getElementById('metaName');
    const metaUse = document.getElementById('metaUse');
    const metaMaterial = document.getElementById('metaMaterial');
    const metaNotes = document.getElementById('metaNotes');
    const applyMetaBtn = document.getElementById('applyMetaBtn');

    const ceSystemEl = document.getElementById('ceSystem');
    const ceSoilEl = document.getElementById('ceSoil');
    const ceComplexityEl = document.getElementById('ceComplexity');

    // Rules UI
    document.getElementById('ruleScale').textContent = String(UNIT_TO_M);
    document.getElementById('ruleMaxH').textContent = String(MAX_HEIGHT_M);
    document.getElementById('ruleMaxF').textContent = String(MAX_FOOTPRINT_M2);
    document.getElementById('ruleZone').textContent = `¬±${ZONE_LIMIT_UNITS}`;

    // Helpers
    function makeBuildingId(){ return Math.random().toString(16).slice(2, 8).toUpperCase(); }
    function defaultMeta(){ return { name: "New Building", use: "residential", material: "concrete", notes: "" }; }
    function defaultCE(){ return { system: "rc_frame", soil: "medium", complexity: "mid" }; }

    function showStatus(msg){
      const statusEl = document.getElementById('statusMsg');
      statusEl.textContent = msg;
      setTimeout(()=> statusEl.textContent = '', 3000);
    }

    // ======= floors AUTO from height =======
    function floorsFromHeightMeters(hMeters){
      // –≤—ã—á–∏—Ç–∞–µ–º –∫—Ä–æ–≤–ª—é/—Ç–µ—Ö —ç—Ç–∞–∂, –æ—Å—Ç–∞—Ç–æ–∫ –¥–µ–ª–∏–º –Ω–∞ –≤—ã—Å–æ—Ç—É —ç—Ç–∞–∂–∞
      const usable = Math.max(0.1, hMeters - ROOF_TECH_M);
      return Math.max(1, Math.round(usable / FLOOR_HEIGHT_M));
    }

    // ======= Visual: build shapes (simple compositing) =======
    function buildShapeForCube(cube, shapeType){
      const keep = [];
      cube.children.forEach(ch => { if (ch.isLineSegments) keep.push(ch); });
      cube.clear();
      keep.forEach(k => cube.add(k));

      const baseMat = cube.material;

      const addPart = (sx, sy, sz, ox, oy, oz) => {
        const g = new THREE.BoxGeometry(1,1,1);
        const m = baseMat.clone();
        m.transparent = true;
        m.opacity = baseMat.opacity ?? 0.95;

        const part = new THREE.Mesh(g, m);
        part.scale.set(sx, sy, sz);
        part.position.set(ox, oy, oz);
        part.castShadow = true;
        part.receiveShadow = true;
        cube.add(part);

        const e = new THREE.EdgesGeometry(g);
        const l = new THREE.LineSegments(e, new THREE.LineBasicMaterial({ color: 0x000000 }));
        part.add(l);
      };

      if (shapeType === "box"){
        addPart(1.0, 1.0, 1.0, 0, 0, 0);
      } else if (shapeType === "tower"){
        addPart(0.92, 0.35, 0.92, 0, -0.32, 0);
        addPart(0.55, 0.95, 0.55, 0,  0.07, 0);
      } else if (shapeType === "stepped"){
        addPart(0.98, 0.55, 0.98, 0, -0.18, 0);
        addPart(0.72, 0.45, 0.72, 0,  0.17, 0);
        addPart(0.50, 0.35, 0.50, 0,  0.47, 0);
      } else if (shapeType === "lshape"){
        addPart(0.88, 0.72, 0.42, -0.14, -0.02,  0.06);
        addPart(0.42, 0.72, 0.88,  0.22, -0.02, -0.14);
      } else {
        addPart(1.0, 1.0, 1.0, 0, 0, 0);
      }
    }

    function applyFacadeStyle(cube, style){
      const mats = [];
      if (cube.material) mats.push(cube.material);
      cube.traverse(obj => { if (obj.isMesh && obj.material) mats.push(obj.material); });

      mats.forEach(m=>{
        m.roughness = 0.5;
        m.metalness = 0.1;
        if (m.emissive){ m.emissive.setHex(0x000000); m.emissiveIntensity = 0.0; }

        if (style === "darkglass"){
          m.roughness = 0.2; m.metalness = 0.3;
          if (m.color) m.color.offsetHSL(0, -0.2, -0.22);
        }
        if (style === "bands"){
          if (m.emissive){ m.emissive.setHex(0x111111); m.emissiveIntensity = 0.55; }
          m.roughness = 0.4;
        }
        if (style === "grid"){
          if (m.emissive){ m.emissive.setHex(0x222222); m.emissiveIntensity = 0.7; }
          m.roughness = 0.3;
        }
      });
    }

    function setCubeBaseColor(cube, hex){
      cube.material.color.setHex(hex);
      cube.traverse(obj => {
        if (obj.isMesh && obj.material && obj !== cube){
          obj.material.color.setHex(hex);
        }
      });
    }

    // ======= AUTO STYLE BY USE =======
    function applyUsePreset(cube, use){
      const preset = USE_VISUAL_PRESET[use] || USE_VISUAL_PRESET.other;
      cube.userData.visual = { shapeType: preset.shapeType, facadeStyle: preset.facadeStyle };
      buildShapeForCube(cube, preset.shapeType);
      applyFacadeStyle(cube, preset.facadeStyle);
      setCubeBaseColor(cube, preset.color);
    }

    // --- Create cube + plane ---
    function createCubeWithPlane(size = 1.0, color = null, position = null) {
      const grayScale = Math.random() * 0.3 + 0.5; // 0.5 - 0.8
      const cubeColor = color || new THREE.Color().setScalar(grayScale);

      const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
      const cubeMaterial = new THREE.MeshStandardMaterial({
        color: cubeColor,
        roughness: 0.5,
        metalness: 0.1,
        emissive: 0x000000,
        transparent: true,
        opacity: 0.95
      });

      const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
      cube.castShadow = true;
      cube.receiveShadow = true;
      cube.scale.set(size, size, size);

      const planeWidth = size * 1.4;
      const planeDepth = size * 1.4;
      const planeGeometry = new THREE.BoxGeometry(planeWidth, 0.1, planeDepth);
      const planeMaterial = new THREE.MeshStandardMaterial({
        color: 0x222222,
        roughness: 0.8,
        metalness: 0.0,
        emissive: 0x000000
      });

      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.castShadow = true;
      plane.receiveShadow = true;

      const planeEdges = new THREE.EdgesGeometry(planeGeometry);
      const planeLine = new THREE.LineSegments(planeEdges, new THREE.LineBasicMaterial({ color: 0x444444 }));
      plane.add(planeLine);

      if (position) cube.position.copy(position);
      else { cube.position.x = (Math.random() - 0.5) * 4; cube.position.z = (Math.random() - 0.5) * 4; }

      cube.position.y = size / 2 + 0.05;

      plane.position.x = cube.position.x;
      plane.position.y = 0.05;
      plane.position.z = cube.position.z;

      const edges = new THREE.EdgesGeometry(cubeGeometry);
      const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
      cube.add(line);

      cube.userData.buildingId = makeBuildingId();
      cube.userData.meta = defaultMeta();
      cube.userData.ce = defaultCE();

      applyUsePreset(cube, cube.userData.meta.use);

      return { cube, plane };
    }

    function updatePlanePosition(cube, plane){
      if (!cube || !plane) return;
      plane.position.x = cube.position.x;
      plane.position.z = cube.position.z;
      plane.position.y = 0.05;
    }

    function updatePlaneSize(cube, plane){
      if (!cube || !plane) return;
      const newWidth = cube.scale.x * 1.4;
      const newDepth = cube.scale.z * 1.4;

      plane.geometry.dispose();
      plane.geometry = new THREE.BoxGeometry(newWidth, 0.1, newDepth);

      const toRemove = [];
      plane.children.forEach(ch => { if (ch.isLineSegments) toRemove.push(ch); });
      toRemove.forEach(ch => plane.remove(ch));

      const newEdges = new THREE.EdgesGeometry(plane.geometry);
      const newLine = new THREE.LineSegments(newEdges, new THREE.LineBasicMaterial({ color: 0x444444 }));
      plane.add(newLine);
    }

    function updateSelectionHighlight(){
      cubes.forEach(c=>{
        c.material.emissive.setHex(0x000000);
        c.material.opacity = 0.95;
      });

      if (selectedCube){
        selectedCube.material.emissive.setHex(0x222222);
        selectedCube.material.opacity = 1.0;

        const pos = selectedCube.position;
        document.getElementById('selected-info').innerHTML =
          `‚úì –í—ã–±—Ä–∞–Ω: –∑–¥–∞–Ω–∏–µ<br>X=${pos.x.toFixed(2)} –º Y=${pos.y.toFixed(2)} –º Z=${pos.z.toFixed(2)} –º`;
      } else {
        document.getElementById('selected-info').innerHTML = 'üëÜ –ö–ª–∏–∫–Ω–∏ –ø–æ –∑–¥–∞–Ω–∏—é –¥–ª—è –≤—ã–±–æ—Ä–∞';
      }

      syncInspectorFromSelected();
    }

    function updateSliderValuesFromSelected(){
      if (!selectedCube) return;
      document.getElementById('widthSlider').value = selectedCube.scale.x;
      document.getElementById('heightSlider').value = selectedCube.scale.y;
      document.getElementById('depthSlider').value = selectedCube.scale.z;

      document.getElementById('widthVal').textContent = selectedCube.scale.x.toFixed(1) + ' –º';
      document.getElementById('heightVal').textContent = selectedCube.scale.y.toFixed(1) + ' –º';
      document.getElementById('depthVal').textContent = selectedCube.scale.z.toFixed(1) + ' –º';
    }

    function syncInspectorFromSelected(){
      if (!selectedCube){
        bId.textContent = "‚Äî";
        bPos.textContent = "‚Äî";
        bSize.textContent = "‚Äî";
        bFootprint.textContent = "‚Äî";
        bVolume.textContent = "‚Äî";
        bHeightM.textContent = "‚Äî";
        bFloorsAuto.textContent = "‚Äî";
        bUseTag.textContent = "‚Äî";
        warnBox.style.display = "none";
        okBox.style.display = "none";
        return;
      }

      selectedCube.userData.meta = selectedCube.userData.meta || defaultMeta();
      selectedCube.userData.ce = selectedCube.userData.ce || defaultCE();

      const wU = selectedCube.scale.x;
      const hU = selectedCube.scale.y;
      const dU = selectedCube.scale.z;

      const x = selectedCube.position.x;
      const y = selectedCube.position.y;
      const z = selectedCube.position.z;

      const wM = wU * UNIT_TO_M;
      const hM = hU * UNIT_TO_M;
      const dM = dU * UNIT_TO_M;

      const footprintM2 = (wM * dM);
      const volumeM3 = (wM * hM * dM);

      const floorsAuto = floorsFromHeightMeters(hM);

      bId.textContent = selectedCube.userData.buildingId || "‚Äî";
      bPos.textContent = `x=${x.toFixed(2)} –º y=${y.toFixed(2)} –º z=${z.toFixed(2)} –º`;
      bSize.textContent = `${(wU*UNIT_TO_M).toFixed(1)} √ó ${(hU*UNIT_TO_M).toFixed(1)} √ó ${(dU*UNIT_TO_M).toFixed(1)} –º`;
      bFootprint.textContent = `${footprintM2.toFixed(0)} –º¬≤`;
      bVolume.textContent = `${volumeM3.toFixed(0)} –º¬≥`;
      bHeightM.textContent = `${hM.toFixed(1)} –º`;
      bFloorsAuto.textContent = `‚âà ${floorsAuto} —ç—Ç.`;
      bUseTag.textContent = metaUse.options[metaUse.selectedIndex]?.text || "‚Äî";

      const meta = selectedCube.userData.meta;
      metaName.value = meta.name ?? "";
      metaUse.value = meta.use ?? "residential";
      metaMaterial.value = meta.material ?? "";
      metaNotes.value = meta.notes ?? "";

      const ce = selectedCube.userData.ce;
      ceSystemEl.value = ce.system ?? "rc_frame";
      ceSoilEl.value = ce.soil ?? "medium";
      ceComplexityEl.value = ce.complexity ?? "mid";

      warnBox.style.display = "none";
      okBox.style.display = "none";
      warnBox.innerHTML = "";
      okBox.innerHTML = "";

      const problems = [];
      if (hM > MAX_HEIGHT_M) problems.push(`–í—ã—Å–æ—Ç–∞ ${hM.toFixed(1)} –º > ${MAX_HEIGHT_M} –º`);
      if (footprintM2 > MAX_FOOTPRINT_M2) problems.push(`–ü—è—Ç–Ω–æ ${footprintM2.toFixed(0)} –º¬≤ > ${MAX_FOOTPRINT_M2} –º¬≤`);
      if (Math.abs(x) > ZONE_LIMIT_UNITS || Math.abs(z) > ZONE_LIMIT_UNITS) problems.push(`–í—ã—Ö–æ–¥ –∑–∞ –∑–æ–Ω—É ¬±${ZONE_LIMIT_UNITS} –º`);

      const ceSystem = ceSystemEl.value || "rc_frame";
      const ceSoil = ceSoilEl.value || "medium";
      const ceComplexity = ceComplexityEl.value || "mid";

      const use = meta.use || "residential";
      const gfaM2 = footprintM2 * floorsAuto;

      const costBase = (COST_PER_M2[ceSystem] || 800) * gfaM2;
      const cost = costBase * (COMPLEXITY_MULT[ceComplexity] || 1.0);

      const timeMonths = (0.0025 * gfaM2) * (0.7 + floorsAuto * 0.06) * (COMPLEXITY_MULT[ceComplexity] || 1.0);
      const timeText = (timeMonths < 1) ? `${Math.max(2, Math.round(timeMonths * 4))} –Ω–µ–¥` : `${Math.round(timeMonths)} –º–µ—Å`;

      const co2Kg = (CO2_PER_M2[ceSystem] || 300) * gfaM2;
      const massTons = (DEADLOAD_KN_PER_M2[ceSystem] || 6) * gfaM2 * 0.102;
      const totalKN = (DEADLOAD_KN_PER_M2[ceSystem] || 6) * gfaM2;
      const bearingDemand = totalKN / footprintM2;
      const soilCap = SOIL_BEARING_KPA[ceSoil] || 150;

      const peopleFactor = USE_FACTORS[use] || USE_FACTORS.other;
      const peakPeople = Math.round(gfaM2 * peopleFactor.people_per_m2);
      const parking = Math.round((gfaM2 / 1000) * peopleFactor.parking_per_1000m2);

      const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      setText("ceGfa", `${gfaM2.toFixed(0)} –º¬≤`);
      setText("ceCost", `$${(cost/1e6).toFixed(2)} –º–ª–Ω`);
      setText("ceTime", timeText);
      setText("ceCo2", `${(co2Kg/1000).toFixed(0)} —Ç`);
      setText("ceMass", `${massTons.toFixed(0)} —Ç`);
      setText("ceBearing", `${bearingDemand.toFixed(0)} / ${soilCap} –∫–ü–∞`);
      setText("ceParking", `${parking} –º–µ—Å—Ç`);
      setText("cePeopleFlow", `${peakPeople} —á–µ–ª`);

      if (bearingDemand > soilCap){
        problems.push(`–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≥—Ä—É–Ω—Ç ${bearingDemand.toFixed(0)} –∫–ü–∞ > ${soilCap} –∫–ü–∞`);
      }

      if (problems.length){
        warnBox.innerHTML = "‚ö† " + problems.join(" ‚Ä¢ ");
        warnBox.style.display = "block";
      } else {
        okBox.innerHTML = "‚úì –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –Ω–æ—Ä–º–µ";
        okBox.style.display = "block";
      }
    }

    function resizeSelectedCube(){
      if (!selectedCube) return;

      const w = parseFloat(document.getElementById('widthSlider').value);
      const h = parseFloat(document.getElementById('heightSlider').value);
      const d = parseFloat(document.getElementById('depthSlider').value);

      selectedCube.scale.set(w, h, d);
      selectedCube.position.y = h / 2 + 0.05;

      const plane = selectedCube.userData.plane;
      if (plane) updatePlaneSize(selectedCube, plane);

      const use = (selectedCube.userData.meta?.use) || "residential";
      applyUsePreset(selectedCube, use);

      document.getElementById('widthVal').textContent = w.toFixed(1) + ' –º';
      document.getElementById('heightVal').textContent = h.toFixed(1) + ' –º';
      document.getElementById('depthVal').textContent = d.toFixed(1) + ' –º';

      updateSelectionHighlight();
    }

    function moveSelected(dx, dy, dz){
      if (!selectedCube) return;

      selectedCube.position.x += dx;
      selectedCube.position.y += dy;
      selectedCube.position.z += dz;

      if (selectedCube.position.y < selectedCube.scale.y / 2 + 0.05){
        selectedCube.position.y = selectedCube.scale.y / 2 + 0.05;
      }

      const plane = selectedCube.userData.plane;
      if (plane) updatePlanePosition(selectedCube, plane);

      updateSelectionHighlight();
    }

    // Delete selected
    function deleteSelected(){
      if (!selectedCube) { showStatus("‚ùå –ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å"); return; }

      const plane = selectedCube.userData.plane;

      scene.remove(selectedCube);
      if (plane) scene.remove(plane);

      try{
        selectedCube.traverse(obj=>{
          if (obj.isMesh){
            obj.geometry?.dispose?.();
            if (obj.material){
              if (Array.isArray(obj.material)) obj.material.forEach(m=>m.dispose?.());
              else obj.material.dispose?.();
            }
          }
        });
      }catch{}

      if (plane){
        try{
          plane.traverse(obj=>{
            if (obj.isMesh){
              obj.geometry?.dispose?.();
              if (obj.material){
                if (Array.isArray(obj.material)) obj.material.forEach(m=>m.dispose?.());
                else obj.material.dispose?.();
              }
            }
          });
        }catch{}
      }

      const ci = cubes.indexOf(selectedCube);
      if (ci !== -1) cubes.splice(ci, 1);

      if (plane){
        const pi = planes.indexOf(plane);
        if (pi !== -1) planes.splice(pi, 1);
      }

      selectedCube = cubes[0] || null;
      updateSelectionHighlight();
      updateSliderValuesFromSelected();
      showStatus("üóë –£–¥–∞–ª–µ–Ω–æ");
    }

    // Raycast select
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function onClick(event){
      const el = document.elementFromPoint(event.clientX, event.clientY);
      if (el && (el.closest('#info') || el.closest('#inspector'))) return;

      mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
      mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const allObjects = [...cubes, ...planes];
      const intersects = raycaster.intersectObjects(allObjects, true);

      if (intersects.length > 0){
        const hit = intersects[0].object;

        let obj = hit;
        while (obj && !cubes.includes(obj) && obj.parent) obj = obj.parent;

        if (obj && cubes.includes(obj)) selectedCube = obj;
        else if (hit.userData && hit.userData.cube) selectedCube = hit.userData.cube;

        updateSelectionHighlight();
        updateSliderValuesFromSelected();
      }
    }

    // Export/Import
    function exportToJSON(){
      const cubesData = cubes.map(cube => ({
        buildingId: cube.userData.buildingId || null,
        meta: cube.userData.meta || null,
        ce: cube.userData.ce || null,
        visual: cube.userData.visual || null,
        scale: { x: cube.scale.x, y: cube.scale.y, z: cube.scale.z },
        position: { x: cube.position.x, y: cube.position.y, z: cube.position.z },
        color: cube.material.color.getHex()
      }));
      return JSON.stringify(cubesData, null, 2);
    }

    function importFromJSON(jsonStr){
      try{
        const cubesData = JSON.parse(jsonStr);

        cubes.forEach(c => scene.remove(c));
        planes.forEach(p => scene.remove(p));
        cubes.length = 0;
        planes.length = 0;

        cubesData.forEach(data=>{
          const color = new THREE.Color(data.color);
          const position = new THREE.Vector3(data.position.x, data.position.y, data.position.z);

          const { cube, plane } = createCubeWithPlane(data.scale.x, color, position);

          cube.scale.set(data.scale.x, data.scale.y, data.scale.z);
          cube.position.set(data.position.x, data.position.y, data.position.z);
          cube.position.y = data.scale.y / 2 + 0.05;

          cube.userData.buildingId = data.buildingId || makeBuildingId();
          cube.userData.meta = data.meta || defaultMeta();
          cube.userData.ce = data.ce || defaultCE();

          updatePlanePosition(cube, plane);
          updatePlaneSize(cube, plane);

          cube.userData.plane = plane;
          plane.userData.cube = cube;

          applyUsePreset(cube, cube.userData.meta.use);

          scene.add(cube);
          scene.add(plane);
          cubes.push(cube);
          planes.push(plane);
        });

        selectedCube = cubes[0] || null;
        updateSelectionHighlight();
        updateSliderValuesFromSelected();
        showStatus('‚úì –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω');
      } catch(e){
        showStatus('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
      }
    }

    // ======= –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–¢–ü–†–ê–í–ö–ê –í–´–ë–†–ê–ù–ù–û–ì–û –û–ë–™–ï–ö–¢–ê –ù–ê –ö–ê–†–¢–£ =======
    function sendSelectedToMap() {
      if (!selectedCube) {
        showStatus("‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏");
        return;
      }
      if (!window.opener) {
        showStatus("‚ùå –†–µ–¥–∞–∫—Ç–æ—Ä –æ—Ç–∫—Ä—ã—Ç –Ω–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞");
        return;
      }

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ (—Ä–∞–∑–º–µ—Ä—ã –≤ –º–µ—Ç—Ä–∞—Ö, —Ü–≤–µ—Ç, —Ç–∏–ø)
      const wU = selectedCube.scale.x;
      const hU = selectedCube.scale.y;
      const dU = selectedCube.scale.z;

      const obj = {
        type: selectedCube.userData.meta?.use || 'residential',
        height: hU * UNIT_TO_M,        // –º–µ—Ç—Ä—ã
        width: wU * UNIT_TO_M,         // –º–µ—Ç—Ä—ã
        depth: dU * UNIT_TO_M,         // –º–µ—Ç—Ä—ã
        color: '#' + selectedCube.material.color.getHexString()
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –æ–∫–Ω—É
      window.opener.postMessage({ type: 'OBJECT_CREATED', object: obj }, '*');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
      showStatus("‚úÖ –û–±—ä–µ–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è...");
      setTimeout(() => window.close(), 1000);
    }

    // UI handlers
    renderer.domElement.addEventListener('click', onClick);

    document.getElementById('addCubeBtn').addEventListener('click', () => {
      const { cube, plane } = createCubeWithPlane(1.0);
      scene.add(cube);
      scene.add(plane);

      cubes.push(cube);
      planes.push(plane);

      cube.userData.plane = plane;
      plane.userData.cube = cube;

      selectedCube = cube;
      updateSelectionHighlight();
      updateSliderValuesFromSelected();
      showStatus("‚úì –ó–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ");
    });

    document.getElementById('deleteBtn').addEventListener('click', deleteSelected);
    window.addEventListener('keydown', (e) => {
      if (e.key === "Delete" || e.key === "Backspace") deleteSelected();
    });

    // –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
    document.getElementById('sendToMapBtn').addEventListener('click', sendSelectedToMap);

    document.getElementById('widthSlider').addEventListener('input', resizeSelectedCube);
    document.getElementById('heightSlider').addEventListener('input', resizeSelectedCube);
    document.getElementById('depthSlider').addEventListener('input', resizeSelectedCube);

    document.getElementById('moveLeft').addEventListener('click', () => moveSelected(-0.5, 0, 0));
    document.getElementById('moveRight').addEventListener('click', () => moveSelected(0.5, 0, 0));
    document.getElementById('moveDown').addEventListener('click', () => moveSelected(0, -0.5, 0));
    document.getElementById('moveUp').addEventListener('click', () => moveSelected(0, 0.5, 0));
    document.getElementById('moveBack').addEventListener('click', () => moveSelected(0, 0, -0.5));
    document.getElementById('moveForward').addEventListener('click', () => moveSelected(0, 0, 0.5));

    document.getElementById('exportBtn').addEventListener('click', () => {
      const json = exportToJSON();
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'buildings.json';
      a.click();
      URL.revokeObjectURL(url);
      showStatus('üìÅ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    });

    document.getElementById('copyToClipboardBtn').addEventListener('click', () => {
      const json = exportToJSON();
      navigator.clipboard.writeText(json).then(() => showStatus('üìã JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'));
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => importFromJSON(event.target.result);
        reader.readAsText(file);
      };
      input.click();
    });

    window.addEventListener('paste', (e) => {
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      if (pastedText && pastedText.includes('"scale"')) {
        if (confirm('–í—Å—Ç–∞–≤–∏—Ç—å JSON?')) importFromJSON(pastedText);
      }
    });

    applyMetaBtn.addEventListener('click', () => {
      if (!selectedCube) return;

      selectedCube.userData.meta = {
        name: metaName.value.trim() || "New Building",
        use: metaUse.value,
        material: metaMaterial.value.trim(),
        notes: metaNotes.value.trim()
      };

      selectedCube.userData.ce = {
        system: ceSystemEl.value,
        soil: ceSoilEl.value,
        complexity: ceComplexityEl.value
      };

      applyUsePreset(selectedCube, selectedCube.userData.meta.use);

      showStatus("‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      syncInspectorFromSelected();
    });

    metaUse.addEventListener('change', () => {
      if (!selectedCube) return;
      selectedCube.userData.meta = selectedCube.userData.meta || defaultMeta();
      selectedCube.userData.meta.use = metaUse.value;

      applyUsePreset(selectedCube, metaUse.value);
      showStatus("üé® –í–∏–¥ –æ–±–Ω–æ–≤–ª—ë–Ω");
      syncInspectorFromSelected();
    });

    [ceSystemEl, ceSoilEl, ceComplexityEl].forEach(el => {
      el.addEventListener('change', () => {
        if (selectedCube) {
          selectedCube.userData.ce = {
            system: ceSystemEl.value,
            soil: ceSoilEl.value,
            complexity: ceComplexityEl.value
          };
        }
        syncInspectorFromSelected();
      });
    });

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Add first building
    const first = createCubeWithPlane(1.2);
    scene.add(first.cube);
    scene.add(first.plane);
    cubes.push(first.cube);
    planes.push(first.plane);
    selectedCube = first.cube;

    first.cube.userData.plane = first.plane;
    first.plane.userData.cube = first.cube;

    updateSelectionHighlight();
    updateSliderValuesFromSelected();

    // Animate
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>